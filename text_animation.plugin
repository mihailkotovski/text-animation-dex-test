"""
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚°ø‚†ü‚†ã‚†â‚†â‚†â‚†â‚†õ‚†ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†õ‚†â‚†â‚†Ñ‚†à‚†â‚†ô‚†ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚°ø‚†ã‚†Ñ‚£†‚£∂‚£ø‚£ø‚£ø‚£∑‚£¶‚£Ñ‚†à‚†õ‚¢ü‚¢Å‚£†‚£§‚£¥‚£∂‚£§‚£Ñ‚†Ñ‚†Ñ‚†Ñ‚†à‚¢ø‚£ø‚£ø
‚£ø‚°ø‚†Å‚¢†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚£ø‚£¶‚£Ä‚†à‚†õ‚†õ‚†ã‚£∏‚£ø‚£ø‚£∑‚°Ñ‚†Ñ‚†Ñ‚†Ñ‚¢ª‚£ø
‚£ø‚†Å‚¢Ä‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ã‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£∂‚£∂‚£æ‚£ø‚£ø‚£ø‚£ø‚£ß‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
‚£ø‚†Ñ‚¢∏‚£ø‚£ø‚£ø‚£ø‚£ø‚†ü‚†Å‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†ô‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
‚£ø‚†Ñ‚†ò‚£ø‚£ø‚£ø‚£ø‚°è‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
‚£ø‚†Ñ‚†Ñ‚¢ª‚£ø‚£ø‚£ø‚†Å‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚¢†‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚¢Ä‚£ø
‚£ø‚°Ü‚†Ñ‚†à‚†ø‚†ø‚†ã‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚¢∞‚£∂‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†Ñ‚†Ñ‚†Ñ‚£∏‚£ø
‚£ø‚£ø‚°Ä‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á‚†Ñ‚†Ñ‚£∞‚£ø‚£ø
‚£ø‚£ø‚£∑‚°Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ü‚†Ñ‚†Ñ‚£∞‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£∞‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†è‚†Ñ‚¢Ä‚£¥‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£∞‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†É‚†Ñ‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£Ñ‚†Ñ‚†Ñ‚†Ñ‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚†ã‚¢Ä‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶‚£Ä‚†Ñ‚†ô‚¢ø‚£ø‚†ü‚†ã‚£†‚£∂‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£¶‚£Ñ‚£®‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø

 –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∏–¥–µ—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç @mihailkotovski & @mishabotov
 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ DEX –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–∞ @shikaatux ‚ô° —Å–ø–∞—Å–∏–±–æ!
 
 –ö—Ä–∞–∂–∞ –∫–æ–¥–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∞–≤—Ç–æ—Ä—Å—Ç–≤–∞ —è–≤–ª—è–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–º –Ω–µ—É–≤–∞–∂–µ–Ω–∏–µ–º –∫ —Ä–∞–±–æ—Ç–µ –∞–≤—Ç–æ—Ä–∞.
  –£–≤–∞–∂–∞–π—Ç–µ —á—É–∂–æ–π —Ç—Ä—É–¥: –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∑—ã–≤–∞–π—Ç–µ @mihailkotovski –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ (@mishabotov)
   –ë–µ—Ä—ë—Ç–µ ‚Äî –Ω–æ –¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º :)
   
   –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∏–¥–µ—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –æ—Ç @mihailkotovski & @mishabotov
  –ò–¥–µ—è –∂–∏–¥–∫–æ–≥–æ –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç @dekma0091 —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç @mihailkotovski
 –ü–ª–∞–≤–Ω—ã–π –∫—É—Ä—Å–æ—Ä –∏ –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –±—É–∫–≤ —Å–≤–µ—Ä—Ö—É –æ—Ç @shikaatux

4.0.0:
 - –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç "Thanos" —Å —Ä–∞—Å–ø–∞–¥–æ–º —á–∞—Å—Ç–∏—Ü –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ñ–∞–π–ª –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö
 - –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏

5.0.0:
 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ (–≤—Ä–æ–¥–µ) –∏ –¥–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ç–∞–Ω–æ—Å–∞

6.0.0:
 - –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –Ω–∞ DEX-–∑–∞–≥—Ä—É–∑—á–∏–∫
 - –í—Å—è –ª–æ–≥–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π DEX –º–æ–¥—É–ª—å
 - –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
 - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DEX –º–æ–¥—É–ª—è
 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ "–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã" –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

7.0.0:
 - üîä –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–≤—É–∫–æ–≤ –ø–µ—á–∞—Ç–∏ (Typing Sound)
 - –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–≤—É–∫–∞: —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫–ª–∏–∫, –ø–µ—á–∞—Ç–Ω–∞—è –º–∞—à–∏–Ω–∫–∞, –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π, –º—è–≥–∫–∏–π, –ø—É–∑—ã—Ä—å–∫–∏
 - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤
 - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (0-100%)
 - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—Å–æ—Ç—ã —Ç–æ–Ω–∞ (pitch) —Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π
 - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ SoundPool
"""

__id__ = "text_animation"
__name__ = "Text Animation"
__description__ = "Animation of text appearance with Blur, Slide, Scale, Rotate, Thanos effects + Liquid cursor + Typing Sound"
__author__ = "@mihailkotovski & @mishabotov"
__version__ = "7.0.0 [DEX]"
__icon__ = "DateRegBot_by_MoiStikiBot/18"
__min_version__ = "11.12.1"

import os
import json
import time
import base64
import requests
from typing import Any, Optional
from base_plugin import BasePlugin
from client_utils import get_last_fragment
from android_utils import run_on_ui_thread, log
from ui.bulletin import BulletinHelper
from ui.settings import Header, Switch, Input, Divider, Text
from org.telegram.messenger import ApplicationLoader, LocaleController
from java.nio import ByteBuffer
from dalvik.system import InMemoryDexClassLoader
from base_plugin import MethodHook
from java.lang import Class as JClass


DEFAULT_DEX_URL = "https://github.com/mihailkotovski/text-animation-dex-test/raw/main/text_animation.dex"
VERSION_URL = "https://github.com/mihailkotovski/text-animation-dex-test/raw/main/version.txt"
DEX_CLASS_NAME = "com.textanimation.TextAnimationCore"
CONFIG_FILE_EXTENSION = ".animtext"
CONFIG_VERSION = 1

CONFIG_KEYS = [
    "enabled", "duration", "blur_duration", "blur_enabled", "blur_radius",
    "blur_text_delay", "slide_enabled", "slide_dist", "scale_enabled",
    "scale_start", "rotate_enabled", "rotate_angle", "delete_anim_enabled",
    "particle_count", "particle_speed", "particle_size", "ignore_mass_delete",
    "mass_delete_threshold", "assemble_anim_enabled", "assemble_particle_count",
    "assemble_particle_speed", "assemble_particle_size", "assemble_spread",
    "cursor_enabled", "cursor_speed", "cursor_width",
    "liquid_cursor_enabled", "liquid_scale_factor", "ignore_spaces", "debug_mode",
    "spoiler_enabled", "spoiler_duration", "spoiler_particle_speed",
    "spoiler_fade_in", "spoiler_fade_out", "spoiler_particle_count",
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞ –ø–µ—á–∞—Ç–∏
    "typing_sound_enabled", "typing_sound_type", "typing_sound_volume",
    "typing_sound_pitch", "typing_sound_pitch_variation", "typing_sound_pitch_range",
    "typing_sound_custom_path"
]

CONFIG_DEFAULTS = {
    "enabled": True,
    "duration": "300",
    "blur_duration": "300",
    "blur_enabled": True,
    "blur_radius": "10",
    "blur_text_delay": "20",
    "slide_enabled": True,
    "slide_dist": "20",
    "scale_enabled": False,
    "scale_start": "0.0",
    "rotate_enabled": False,
    "rotate_angle": "-15",
    "delete_anim_enabled": True,
    "particle_count": "5",
    "particle_speed": "50",
    "particle_size": "50",
    "ignore_mass_delete": True,
    "mass_delete_threshold": "3",
    "assemble_anim_enabled": False,
    "assemble_particle_count": "5",
    "assemble_particle_speed": "50",
    "assemble_particle_size": "50",
    "assemble_spread": "50",
    "cursor_enabled": True,
    "cursor_speed": "25",
    "cursor_width": "5",
    "liquid_cursor_enabled": False,
    "liquid_scale_factor": "15",
    "ignore_spaces": True,
    "debug_mode": False,
    "spoiler_enabled": False,
    "spoiler_duration": "1000",
    "spoiler_particle_speed": "50",
    "spoiler_fade_in": "150",
    "spoiler_fade_out": "200",
    "spoiler_particle_count": "15",
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞ –ø–µ—á–∞—Ç–∏
    "typing_sound_enabled": False,
    "typing_sound_type": "0",  # 0=None, 1=Typewriter, 2=Mechanical, 3=Soft, 4=Bubble, 5=Custom
    "typing_sound_volume": "50",
    "typing_sound_pitch": "100",
    "typing_sound_pitch_variation": True,
    "typing_sound_pitch_range": "10",
    "typing_sound_custom_path": ""
}


class OpenDocumentHook(MethodHook):
    def __init__(self, plugin):
        super().__init__()
        self.plugin = plugin
    
    def before_hooked_method(self, param):
        try:
            message = param.args[0]
            if not message:
                return
            
            file_name = str(message.getFileName())
            if file_name.lower().endswith(CONFIG_FILE_EXTENSION):
                m_name = param.method.getName()
                if "openForView" in m_name:
                    param.setResult(True)
                else:
                    param.setResult(None)
                
                path = message.messageOwner.attachPath
                if not path or not os.path.exists(str(path)):
                    try:
                        from java import jclass
                        FileLoader = jclass("org.telegram.messenger.FileLoader")
                        f = FileLoader.getInstance(message.currentAccount).getPathToMessage(message.messageOwner)
                        path = f.getAbsolutePath()
                    except:
                        path = None
                
                if path and os.path.exists(str(path)):
                    run_on_ui_thread(lambda: self.plugin._handle_config_file_open(str(path)))
                else:
                    BulletinHelper.show_error("–§–∞–π–ª –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω" if self.plugin._is_russian() else "File not downloaded or not found")
        except:
            pass


class DexLoader:
    
    def _get_object_class(self):
        from java import jclass
        return jclass("java.lang.Object")
    
    def __init__(self, plugin: BasePlugin):
        self.plugin = plugin
        self.dex_class = None
        self.dex_loader = None
        self.download_url = DEFAULT_DEX_URL
        
        self.cache_dir = os.path.join(
            ApplicationLoader.applicationContext.getFilesDir().getAbsolutePath(),
            "text_animation_cache"
        )
        self.cache_file = os.path.join(self.cache_dir, "animation_core.dex")
        
        if not os.path.exists(self.cache_dir):
            os.makedirs(self.cache_dir)
    
    def get_cached_version(self) -> int:
        try:
            if self.dex_class is None:
                return 0
            version_field = self.dex_class.getDeclaredField("VERSION_CODE")
            version_field.setAccessible(True)
            return int(version_field.get(None))
        except Exception as e:
            self.plugin.log(f"Error getting cached version: {e}")
            return 0
    
    def check_for_updates(self) -> bool:
        try:
            self.plugin.log("Checking for DEX updates...")
            r = requests.get(VERSION_URL, timeout=5)
            r.raise_for_status()
            
            lines = r.text.strip().split('\n')
            remote_version = int(lines[0].strip())
            
            if len(lines) >= 2:
                self.download_url = lines[1].strip()
                self.plugin.log(f"Download URL: {self.download_url}")
            else:
                self.download_url = DEFAULT_DEX_URL
            
            current_version = self.get_cached_version()
            self.plugin.log(f"Remote: {remote_version}, Current: {current_version}")
            
            return remote_version > current_version
        except Exception as e:
            self.plugin.log(f"Update check error: {e}")
            self.download_url = DEFAULT_DEX_URL
            return False

    def download_dex(self) -> bytes:
        try:
            self.plugin.log(f"Downloading DEX from {self.download_url}")
            r = requests.get(self.download_url, timeout=30)
            r.raise_for_status()
            dex_bytes = r.content
            
            with open(self.cache_file, 'wb') as f:
                f.write(dex_bytes)
            
            self.plugin.log(f"DEX cached: {self.cache_file}")
            return dex_bytes
        except Exception as e:
            self.plugin.log(f"Download error: {e}")
            raise
    
    def load_from_cache(self) -> Optional[bytes]:
        try:
            if os.path.exists(self.cache_file):
                with open(self.cache_file, 'rb') as f:
                    return f.read()
            return None
        except Exception as e:
            self.plugin.log(f"Cache load error: {e}")
            return None
    
    def start_from_bytes(self, dex_bytes: bytes):
        try:
            buffer = ByteBuffer.wrap(dex_bytes)
            self.dex_loader = InMemoryDexClassLoader(
                buffer, 
                ApplicationLoader.applicationContext.getClassLoader()
            )
            
            self.dex_class = self.dex_loader.loadClass(DEX_CLASS_NAME)
            
            from java import jclass
            try:
                CoreClass = jclass(DEX_CLASS_NAME)
                CoreClass.getInstance().start()
                self.plugin.log(f"DEX loaded via jclass: {DEX_CLASS_NAME}")
            except Exception as e1:
                self.plugin.log(f"jclass failed: {e1}, trying reflection")
                instance_method = self.dex_class.getDeclaredMethod("getInstance", None)
                instance_method.setAccessible(True)
                
                start_method = self.dex_class.getDeclaredMethod("start", None)
                start_method.setAccessible(True)
                
                java_instance = instance_method.invoke(None, None)
                start_method.invoke(java_instance, None)
                self.plugin.log(f"DEX loaded via reflection: {DEX_CLASS_NAME}")
                
        except Exception as e:
            self.plugin.log(f"DEX start error: {e}")
            raise
    
    def load_and_start(self):
        try:
            cached_bytes = self.load_from_cache()
            
            if cached_bytes is not None:
                self.plugin.log("Loading DEX from cache...")
                self.start_from_bytes(cached_bytes)
                
                try:
                    if self.check_for_updates():
                        self.plugin.log("Downloading DEX update...")
                        self.download_dex()
                        
                        is_ru = self._is_russian()
                        msg = "–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Text Animation! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ." if is_ru else \
                              "Text Animation update available! Restart the app."
                        BulletinHelper.show_info(msg, get_last_fragment())
                except Exception as e:
                    self.plugin.log(f"Update check failed: {e}")
            else:
                self.plugin.log("No cache, downloading DEX...")
                
                try:
                    self.plugin.log(f"Fetching version from {VERSION_URL}")
                    r = requests.get(VERSION_URL, timeout=5)
                    r.raise_for_status()
                    lines = r.text.strip().split('\n')
                    self.plugin.log(f"Version response lines: {len(lines)}")
                    if len(lines) >= 2:
                        self.download_url = lines[1].strip()
                        self.plugin.log(f"Got URL from version.txt: {self.download_url}")
                    else:
                        self.download_url = DEFAULT_DEX_URL
                        self.plugin.log(f"Using default URL: {self.download_url}")
                except Exception as ve:
                    self.plugin.log(f"Version fetch error: {ve}")
                    self.download_url = DEFAULT_DEX_URL
                
                if not self.download_url:
                    self.download_url = DEFAULT_DEX_URL
                    self.plugin.log(f"URL was empty, using default: {self.download_url}")
                
                dex_bytes = self.download_dex()
                self.start_from_bytes(dex_bytes)
                
        except Exception as e:
            if "proxy" in str(e).lower():
                return
            self.plugin.log(f"Fatal DEX error: {e}")
            BulletinHelper.show_error(f"Text Animation load error: {e}", get_last_fragment())
    
    def _is_russian(self) -> bool:
        try:
            lang = LocaleController.getInstance().getCurrentLocale().getLanguage()
            return str(lang).startswith("ru")
        except:
            return False

    def update_settings(self, settings: dict):
        try:
            if self.dex_class:
                from java import jclass
                settings_json = json.dumps(settings)
                
                try:
                    CoreClass = jclass(DEX_CLASS_NAME)
                    CoreClass.getInstance().updateSettings(settings_json)
                except Exception as e1:
                    self.plugin.log(f"jclass settings failed: {e1}, trying reflection")
                    String = jclass("java.lang.String")
                    param_types = [String.getClass()]
                    
                    instance_method = self.dex_class.getDeclaredMethod("getInstance", None)
                    instance_method.setAccessible(True)
                    
                    method = self.dex_class.getDeclaredMethod("updateSettings", param_types)
                    method.setAccessible(True)
                    
                    method.invoke(instance_method.invoke(None, None), [settings_json])
        except Exception as e:
            self.plugin.log(f"Settings update error: {e}")
    
    def unload(self):
        try:
            if self.dex_class:
                from java import jclass
                try:
                    CoreClass = jclass(DEX_CLASS_NAME)
                    CoreClass.getInstance().onUnload()
                    self.plugin.log("DEX unloaded via jclass")
                except Exception as e1:
                    self.plugin.log(f"jclass unload failed: {e1}, trying reflection")
                    instance_method = self.dex_class.getDeclaredMethod("getInstance", None)
                    instance_method.setAccessible(True)
                    
                    method = self.dex_class.getDeclaredMethod("onUnload", None)
                    method.setAccessible(True)
                    
                    method.invoke(instance_method.invoke(None, None), None)
                    self.plugin.log("DEX unloaded via reflection")
        except Exception as e:
            self.plugin.log(f"Unload error: {e}")
        finally:
            self.dex_class = None
            self.dex_loader = None
    


class TextAnimationPlugin(BasePlugin):
    
    def __init__(self):
        super().__init__()
        self.dex_loader: Optional[DexLoader] = None
        self._hooks = []
    
    def _on_setting_change(self, new_value):
        self._sync_settings_to_dex()
    
    def _is_russian(self) -> bool:
        try:
            lang = LocaleController.getInstance().getCurrentLocale().getLanguage()
            return str(lang).startswith("ru")
        except:
            return False
    
    def _get_config_dir(self) -> Optional[str]:
        try:
            from java import jclass
            Environment = jclass("android.os.Environment")
            downloads = Environment.getExternalStoragePublicDirectory(
                Environment.DIRECTORY_DOWNLOADS
            ).getAbsolutePath()
            config_dir = os.path.join(downloads, "TextAnimation")
            if not os.path.exists(config_dir):
                os.makedirs(config_dir)
            return config_dir
        except Exception as e:
            self.log(f"Config dir error: {e}")
            return None
    
    def _handle_config_file_open(self, filepath: str):
        self.log(f"Handling config file: {filepath}")
        
        config = self._load_config_from_file(filepath)
        if config:
            filename = os.path.basename(filepath)
            run_on_ui_thread(lambda: self._show_import_config_sheet(config, filename))
        else:
            BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏" if self._is_russian() else "Failed to read config file")
    
    def _export_config(self) -> dict:
        config = {
            "version": CONFIG_VERSION,
            "plugin_version": __version__,
            "timestamp": int(time.time()),
            "settings": {}
        }
        for key in CONFIG_KEYS:
            default = CONFIG_DEFAULTS.get(key)
            config["settings"][key] = self.get_setting(key, default)
        return config
    
    def _import_config(self, config: dict) -> bool:
        try:
            if "settings" not in config:
                return False
            for key, value in config["settings"].items():
                if key in CONFIG_KEYS:
                    self.set_setting(key, value)
            
            if self.dex_loader:
                self.dex_loader.update_settings(config["settings"])
            return True
        except Exception as e:
            self.log(f"Import error: {e}")
            return False
    
    def _save_config_to_file(self, view=None):
        is_ru = self._is_russian()
        try:
            config = self._export_config()
            config_json = json.dumps(config, indent=2, ensure_ascii=False)
            config_b64 = base64.b64encode(config_json.encode('utf-8')).decode('utf-8')
            
            config_dir = self._get_config_dir()
            if not config_dir:
                BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å" if is_ru else "Save failed")
                return
            
            filename = f"text_anim_{int(time.time())}{CONFIG_FILE_EXTENSION}"
            filepath = os.path.join(config_dir, filename)
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(f"# Text Animation Config v{__version__}\n")
                f.write(f"# {time.strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                f.write(config_b64)
            
            self.log(f"Config saved to: {filepath}")
            self._show_share_dialog(filepath, filename)
            
        except Exception as e:
            self.log(f"Save error: {e}")
            BulletinHelper.show_error(str(e))
    
    def _show_share_dialog(self, filepath, filename):
        from android_utils import OnClickListener
        from java import jclass
        
        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            
            activity = fragment.getParentActivity()
            if not activity:
                return
            
            is_ru = self._is_russian()
            
            BottomSheet = jclass("org.telegram.ui.ActionBar.BottomSheet")
            LinearLayout = jclass("android.widget.LinearLayout")
            TextView = jclass("android.widget.TextView")
            ImageView = jclass("android.widget.ImageView")
            FrameLayout = jclass("android.widget.FrameLayout")
            TypedValue = jclass("android.util.TypedValue")
            Gravity = jclass("android.view.Gravity")
            Theme = jclass("org.telegram.ui.ActionBar.Theme")
            AndroidUtilities = jclass("org.telegram.messenger.AndroidUtilities")
            GradientDrawable = jclass("android.graphics.drawable.GradientDrawable")
            LayoutHelper = jclass("org.telegram.ui.Components.LayoutHelper")
            
            sheet = BottomSheet(activity, False)
            
            container = LinearLayout(activity)
            container.setOrientation(LinearLayout.VERTICAL)
            container.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(24), AndroidUtilities.dp(16), AndroidUtilities.dp(16))
            
            icon_frame = FrameLayout(activity)
            
            icon_bg = GradientDrawable()
            icon_bg.setShape(GradientDrawable.OVAL)
            icon_bg.setColor(Theme.getColor(Theme.key_featuredStickers_addButton) & 0x15FFFFFF | 0x10000000)
            
            icon_view = ImageView(activity)
            R = jclass("org.telegram.messenger.R")
            icon_view.setImageResource(R.drawable.files_storage)
            icon_view.setColorFilter(Theme.getColor(Theme.key_featuredStickers_addButton))
            icon_view.setBackground(icon_bg)
            icon_view.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(16), AndroidUtilities.dp(16), AndroidUtilities.dp(16))
            
            icon_params = jclass("android.widget.FrameLayout$LayoutParams")(AndroidUtilities.dp(72), AndroidUtilities.dp(72))
            icon_params.gravity = Gravity.CENTER
            icon_frame.addView(icon_view, icon_params)
            
            container.addView(icon_frame, LayoutHelper.createLinear(-1, -2, 0, 0, 0, 0, 16))
            
            title_view = TextView(activity)
            title_text = "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞" if is_ru else "Configuration Saved"
            title_view.setText(title_text)
            title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20)
            title_view.setTypeface(AndroidUtilities.bold())
            title_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            title_view.setGravity(Gravity.CENTER)
            container.addView(title_view, LayoutHelper.createLinear(-1, -2, 0, 0, 0, 0, 8))
            
            file_view = TextView(activity)
            file_view.setText(filename)
            file_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            file_view.setTypeface(AndroidUtilities.bold())
            file_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlueText))
            file_view.setGravity(Gravity.CENTER)
            container.addView(file_view, LayoutHelper.createLinear(-1, -2, 0, 0, 0, 0, 8))
            
            desc_view = TextView(activity)
            desc_text = "–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ø–∞–ø–∫—É Downloads/TextAnimation.\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏!" if is_ru else "File saved to Downloads/TextAnimation.\nShare it to transfer your settings!"
            desc_view.setText(desc_text)
            desc_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            desc_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray2))
            desc_view.setGravity(Gravity.CENTER)
            container.addView(desc_view, LayoutHelper.createLinear(-1, -2, 0, 0, 24, 0, 32))
            
            btn_share_frame = FrameLayout(activity)
            btn_share_bg = GradientDrawable()
            btn_share_bg.setCornerRadius(AndroidUtilities.dp(10))
            btn_share_bg.setColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            btn_share_frame.setBackground(btn_share_bg)
            
            share_text_view = TextView(activity)
            share_text_view.setText("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" if is_ru else "Share Config")
            share_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            share_text_view.setTypeface(AndroidUtilities.bold())
            share_text_view.setTextColor(-1)
            share_text_view.setGravity(Gravity.CENTER)
            
            btn_share_frame.addView(share_text_view, LayoutHelper.createFrame(-1, -1))
            
            def on_share(v):
                sheet.dismiss()
                self._share_file(filepath, activity)
                
            btn_share_frame.setOnClickListener(OnClickListener(on_share))
            container.addView(btn_share_frame, LayoutHelper.createLinear(-1, 50, 0, 16, 0, 16, 12))
            
            btn_close_frame = FrameLayout(activity)
            btn_close_bg = GradientDrawable()
            btn_close_bg.setCornerRadius(AndroidUtilities.dp(10))
            btn_close_bg.setColor(Theme.getColor(Theme.key_listSelector))
            btn_close_frame.setBackground(btn_close_bg)
            
            close_text_view = TextView(activity)
            close_text_view.setText("–ó–∞–∫—Ä—ã—Ç—å" if is_ru else "Close")
            close_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            close_text_view.setTypeface(AndroidUtilities.bold())
            close_text_view.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            close_text_view.setGravity(Gravity.CENTER)
            
            btn_close_frame.addView(close_text_view, LayoutHelper.createFrame(-1, -1))
            
            def on_close(v):
                sheet.dismiss()
                
            btn_close_frame.setOnClickListener(OnClickListener(on_close))
            container.addView(btn_close_frame, LayoutHelper.createLinear(-1, 50, 0, 16, 0, 16, 8))
            
            sheet.setCustomView(container)
            sheet.show()
            
        except Exception as e:
            self.log(f"Error showing share dialog: {e}")
            BulletinHelper.show_success(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {filename}" if self._is_russian() else f"Saved: {filename}")
    
    def _share_file(self, filepath, activity):
        try:
            from java import jclass
            
            Intent = jclass("android.content.Intent")
            File = jclass("java.io.File")
            FileProvider = jclass("androidx.core.content.FileProvider")
            ApplicationLoader = jclass("org.telegram.messenger.ApplicationLoader")
            
            file = File(filepath)
            uri = FileProvider.getUriForFile(
                activity,
                ApplicationLoader.getApplicationId() + ".provider",
                file
            )
            
            intent = Intent(Intent.ACTION_SEND)
            intent.setType("application/octet-stream")
            intent.putExtra(Intent.EXTRA_STREAM, uri)
            intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
            
            chooser = Intent.createChooser(intent, "Share Configuration")
            activity.startActivity(chooser)
            
        except Exception as e:
            self.log(f"Error sharing file: {e}")

    def _load_config_from_file(self, filepath: str) -> Optional[dict]:
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                content = f.read()
            
            data_lines = [l for l in content.split('\n') if not l.startswith('#') and l.strip()]
            config_b64 = ''.join(data_lines)
            config_json = base64.b64decode(config_b64).decode('utf-8')
            return json.loads(config_json)
        except Exception as e:
            self.log(f"Load config error: {e}")
            return None
    
    def _show_import_dialog(self, view=None):
        from ui.alert import AlertDialogBuilder
        is_ru = self._is_russian()
        
        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            
            activity = fragment.getParentActivity()
            if not activity:
                return
            
            config_dir = self._get_config_dir()
            if not config_dir or not os.path.exists(config_dir):
                BulletinHelper.show_error("–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" if is_ru else "Folder not found")
                return
            
            files = [f for f in os.listdir(config_dir) if f.endswith(CONFIG_FILE_EXTENSION)]
            files.sort(reverse=True)
            
            if not files:
                BulletinHelper.show_info("–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π" if is_ru else "No configs found")
                return
            
            def on_select(b, which):
                b.dismiss()
                filepath = os.path.join(config_dir, files[which])
                config = self._load_config_from_file(filepath)
                if config:
                    self._show_import_config_sheet(config, files[which])
                else:
                    BulletinHelper.show_error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è" if is_ru else "Read error")
            
            builder = AlertDialogBuilder(activity)
            builder.set_title("–í—ã–±—Ä–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥" if is_ru else "Select Config")
            builder.set_items(files, on_select)
            builder.set_negative_button("–û—Ç–º–µ–Ω–∞" if is_ru else "Cancel", lambda b, w: b.dismiss())
            builder.show()
        except Exception as e:
            self.log(f"Import dialog error: {e}")
    
    def _show_import_config_sheet(self, config_data: dict, filename: str):
        from android_utils import OnClickListener
        from java import jclass
        
        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            
            activity = fragment.getParentActivity()
            if not activity:
                return
            
            is_ru = self._is_russian()
            
            BottomSheet = jclass("org.telegram.ui.ActionBar.BottomSheet")
            LinearLayout = jclass("android.widget.LinearLayout")
            TextView = jclass("android.widget.TextView")
            ImageView = jclass("android.widget.ImageView")
            FrameLayout = jclass("android.widget.FrameLayout")
            ScrollView = jclass("android.widget.ScrollView")
            TypedValue = jclass("android.util.TypedValue")
            Gravity = jclass("android.view.Gravity")
            Theme = jclass("org.telegram.ui.ActionBar.Theme")
            AndroidUtilities = jclass("org.telegram.messenger.AndroidUtilities")
            GradientDrawable = jclass("android.graphics.drawable.GradientDrawable")
            LayoutHelper = jclass("org.telegram.ui.Components.LayoutHelper")
            
            sheet = BottomSheet(activity, False)
            
            main_container = LinearLayout(activity)
            main_container.setOrientation(LinearLayout.VERTICAL)
            main_container.setPadding(AndroidUtilities.dp(16), AndroidUtilities.dp(20), AndroidUtilities.dp(16), AndroidUtilities.dp(16))
            
            header_layout = LinearLayout(activity)
            header_layout.setOrientation(LinearLayout.HORIZONTAL)
            header_layout.setGravity(Gravity.CENTER_VERTICAL)
            
            icon_frame = FrameLayout(activity)
            icon_bg = GradientDrawable()
            icon_bg.setShape(GradientDrawable.OVAL)
            icon_bg.setColor(Theme.getColor(Theme.key_featuredStickers_addButton) & 0x15FFFFFF | 0x10000000)
            
            icon_view = ImageView(activity)
            R = jclass("org.telegram.messenger.R")
            icon_view.setImageResource(R.drawable.files_folder)
            icon_view.setColorFilter(Theme.getColor(Theme.key_featuredStickers_addButton))
            icon_view.setBackground(icon_bg)
            icon_view.setPadding(AndroidUtilities.dp(10), AndroidUtilities.dp(10), AndroidUtilities.dp(10), AndroidUtilities.dp(10))
            
            icon_frame.addView(icon_view, LayoutHelper.createFrame(48, 48))
            header_layout.addView(icon_frame, LayoutHelper.createLinear(48, 48, 0, 0, 16, 0))
            
            title_layout = LinearLayout(activity)
            title_layout.setOrientation(LinearLayout.VERTICAL)
            
            title_tv = TextView(activity)
            title_tv.setText("–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫" if is_ru else "Import Settings")
            title_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20)
            title_tv.setTypeface(AndroidUtilities.bold())
            title_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            title_layout.addView(title_tv)
            
            plugin_ver = config_data.get("plugin_version", "Unknown")
            timestamp = config_data.get("timestamp", 0)
            date_str = time.strftime('%d.%m.%Y', time.localtime(timestamp)) if timestamp > 0 else "Unknown"
            
            sub_tv = TextView(activity)
            sub_tv.setText(f"v{plugin_ver} ‚Ä¢ {date_str}")
            sub_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
            sub_tv.setTextColor(Theme.getColor(Theme.key_dialogTextGray2))
            title_layout.addView(sub_tv)
            
            header_layout.addView(title_layout, LayoutHelper.createLinear(-1, -2))
            main_container.addView(header_layout, LayoutHelper.createLinear(-1, -2, 0, 0, 0, 0, 16))
            
            scroll = ScrollView(activity)
            scroll_content = LinearLayout(activity)
            scroll_content.setOrientation(LinearLayout.VERTICAL)
            
            settings_names = {
                "enabled": ("–ü–ª–∞–≥–∏–Ω –≤–∫–ª—é—á—ë–Ω", "Plugin enabled"),
                "blur_enabled": ("–†–∞–∑–º—ã—Ç–∏–µ", "Blur"),
                "slide_enabled": ("–°–ª–∞–π–¥", "Slide"),
                "scale_enabled": ("–ú–∞—Å—à—Ç–∞–±", "Scale"),
                "rotate_enabled": ("–ü–æ–≤–æ—Ä–æ—Ç", "Rotate"),
                "delete_anim_enabled": ("–≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞–ª–µ–Ω–∏—è", "Delete effect"),
                "assemble_anim_enabled": ("–≠—Ñ—Ñ–µ–∫—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è", "Appear effect"),
                "cursor_enabled": ("–ü–ª–∞–≤–Ω—ã–π –∫—É—Ä—Å–æ—Ä", "Smooth cursor"),
                "liquid_cursor_enabled": ("–ñ–∏–¥–∫–∏–π –∫—É—Ä—Å–æ—Ä", "Liquid cursor"),
            }
            
            settings = config_data.get("settings", {})
            
            list_bg = GradientDrawable()
            list_bg.setCornerRadius(AndroidUtilities.dp(12))
            list_bg.setColor(Theme.getColor(Theme.key_windowBackgroundWhite) & 0x00FFFFFF | 0x08000000)
            scroll_content.setBackground(list_bg)
            scroll_content.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(8), AndroidUtilities.dp(12), AndroidUtilities.dp(8))
            
            for key in settings_names:
                if key in settings:
                    ru_name, en_name = settings_names[key]
                    value = settings[key]
                    name = ru_name if is_ru else en_name
                    
                    if isinstance(value, bool):
                        value_str = "ON" if value else "OFF"
                        val_color = Theme.getColor(Theme.key_featuredStickers_addButton) if value else Theme.getColor(Theme.key_text_RedRegular)
                    else:
                        value_str = str(value)
                        val_color = Theme.getColor(Theme.key_dialogTextBlack)
                    
                    row = LinearLayout(activity)
            # ... (the rest of the loop is in the file)
                    row.setOrientation(LinearLayout.HORIZONTAL)
                    row.setPadding(0, AndroidUtilities.dp(6), 0, AndroidUtilities.dp(6))
                    
                    name_tv = TextView(activity)
                    name_tv.setText(name)
                    name_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
                    name_tv.setTextColor(Theme.getColor(Theme.key_dialogTextGray2))
                    row.addView(name_tv, LayoutHelper.createLinear(0, -2, 1.0))
                    
                    val_tv = TextView(activity)
                    val_tv.setText(value_str)
                    val_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
                    val_tv.setTypeface(AndroidUtilities.bold())
                    val_tv.setTextColor(val_color)
                    row.addView(val_tv, LayoutHelper.createLinear(-2, -2))
                    
                    scroll_content.addView(row)

            scroll.addView(scroll_content)
            main_container.addView(scroll, LayoutHelper.createLinear(-1, 180, 0, 0, 0, 0, 16))
            
            warn_tv = TextView(activity)
            warn_tv.setText("–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã" if is_ru else "Current settings will be replaced")
            warn_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
            warn_tv.setTextColor(Theme.getColor(Theme.key_text_RedRegular))
            warn_tv.setGravity(Gravity.CENTER)
            main_container.addView(warn_tv, LayoutHelper.createLinear(-1, -2, 0, 0, 0, 0, 20))
            
            btns_layout = LinearLayout(activity)
            btns_layout.setOrientation(LinearLayout.HORIZONTAL)
            
            cancel_frame = FrameLayout(activity)
            cancel_bg = GradientDrawable()
            cancel_bg.setCornerRadius(AndroidUtilities.dp(10))
            cancel_bg.setColor(Theme.getColor(Theme.key_listSelector)) 
            cancel_frame.setBackground(cancel_bg)
            
            cancel_tv = TextView(activity)
            cancel_tv.setText("–û—Ç–º–µ–Ω–∞" if is_ru else "Cancel")
            cancel_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            cancel_tv.setTypeface(AndroidUtilities.bold())
            cancel_tv.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            cancel_tv.setGravity(Gravity.CENTER)
            
            cancel_frame.addView(cancel_tv, LayoutHelper.createFrame(-1, -1))
            
            def on_cancel(v):
                sheet.dismiss()
            
            cancel_frame.setOnClickListener(OnClickListener(on_cancel))
            btns_layout.addView(cancel_frame, LayoutHelper.createLinear(0, 48, 1.0, 0, 0, 8, 0))
            
            apply_frame = FrameLayout(activity)
            apply_bg = GradientDrawable()
            apply_bg.setCornerRadius(AndroidUtilities.dp(10))
            apply_bg.setColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            apply_frame.setBackground(apply_bg)
            
            apply_tv = TextView(activity)
            apply_tv.setText("–ü—Ä–∏–º–µ–Ω–∏—Ç—å" if is_ru else "Apply")
            apply_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            apply_tv.setTypeface(AndroidUtilities.bold())
            apply_tv.setTextColor(-1)
            apply_tv.setGravity(Gravity.CENTER)
            
            apply_frame.addView(apply_tv, LayoutHelper.createFrame(-1, -1))
            
            def on_apply(v):
                sheet.dismiss()
                if self._import_config(config_data):
                    BulletinHelper.show_success("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã" if is_ru else "Settings applied")
                    if self.dex_loader:
                        self._sync_settings_to_dex()
                else:
                    BulletinHelper.show_error("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è" if is_ru else "Error applying")
            
            apply_frame.setOnClickListener(OnClickListener(on_apply))
            btns_layout.addView(apply_frame, LayoutHelper.createLinear(0, 48, 1.0, 8, 0, 0, 0))
            
            main_container.addView(btns_layout, LayoutHelper.createLinear(-1, -2))
            
            sheet.setCustomView(main_container)
            sheet.show()
            
        except Exception as e:
            self.log(f"Error showing import sheet: {e}")
            if self._import_config(config_data):
                BulletinHelper.show_success("–ü—Ä–∏–º–µ–Ω–µ–Ω–æ" if self._is_russian() else "Applied")
            else:
                BulletinHelper.show_error("–û—à–∏–±–∫–∞" if self._is_russian() else "Error")
    
    def _clear_dex_cache(self, view=None):
        is_ru = self._is_russian()
        try:
            cache_dir = os.path.join(
                ApplicationLoader.applicationContext.getFilesDir().getAbsolutePath(),
                "text_animation_cache"
            )
            
            if os.path.exists(cache_dir):
                import shutil
                shutil.rmtree(cache_dir)
                self.log(f"DEX cache cleared: {cache_dir}")
                BulletinHelper.show_success(
                    "–ö—ç—à –æ—á–∏—â–µ–Ω! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ." if is_ru else 
                    "Cache cleared! Restart the app."
                )
            else:
                BulletinHelper.show_info(
                    "–ö—ç—à —É–∂–µ –ø—É—Å—Ç" if is_ru else "Cache is already empty"
                )
        except Exception as e:
            self.log(f"Clear cache error: {e}")
            BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}" if is_ru else f"Error: {e}")
    
    def _pick_custom_sound(self, view=None):
        """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–∏–∫–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞"""
        from java import jclass
        
        is_ru = self._is_russian()
        
        try:
            fragment = get_last_fragment()
            if not fragment:
                BulletinHelper.show_error("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞" if is_ru else "No active fragment")
                return
            
            activity = fragment.getParentActivity()
            if not activity:
                BulletinHelper.show_error("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏" if is_ru else "No activity")
                return
            
            Intent = jclass("android.content.Intent")
            
            # –°–æ–∑–¥–∞—ë–º intent –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
            intent = Intent(Intent.ACTION_GET_CONTENT)
            intent.setType("audio/*")
            intent.addCategory(Intent.CATEGORY_OPENABLE)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            intent.putExtra(Intent.EXTRA_LOCAL_ONLY, True)
            
            chooser = Intent.createChooser(
                intent, 
                "–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª" if is_ru else "Select audio file"
            )
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∏–∫–µ—Ä
            # –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ onActivityResult
            activity.startActivityForResult(chooser, 9999)
            
            BulletinHelper.show_info(
                "–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –≤—Ä—É—á–Ω—É—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö" if is_ru else 
                "After selecting, enter the path manually in settings"
            )
            
        except Exception as e:
            self.log(f"Pick sound error: {e}")
            # Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ –ø—É—Ç–∏ –≤—Ä—É—á–Ω—É—é
            self._show_custom_sound_path_dialog()
    
    def _show_custom_sound_path_dialog(self, view=None):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ –ø—É—Ç–∏ –∫ –∞—É–¥–∏–æ —Ñ–∞–π–ª—É –≤—Ä—É—á–Ω—É—é"""
        from ui.alert import AlertDialogBuilder
        from java import jclass
        
        is_ru = self._is_russian()
        
        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            
            activity = fragment.getParentActivity()
            if not activity:
                return
            
            EditText = jclass("android.widget.EditText")
            FrameLayout = jclass("android.widget.FrameLayout")
            LayoutParams = jclass("android.widget.FrameLayout$LayoutParams")
            AndroidUtilities = jclass("org.telegram.messenger.AndroidUtilities")
            Theme = jclass("org.telegram.ui.ActionBar.Theme")
            
            container = FrameLayout(activity)
            
            edit_text = EditText(activity)
            edit_text.setHint("/storage/emulated/0/Download/sound.mp3")
            edit_text.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            edit_text.setHintTextColor(Theme.getColor(Theme.key_dialogTextHint))
            edit_text.setSingleLine(True)
            
            current_path = self.get_setting("typing_sound_custom_path", "")
            if current_path:
                edit_text.setText(current_path)
            
            params = LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT)
            params.leftMargin = AndroidUtilities.dp(24)
            params.rightMargin = AndroidUtilities.dp(24)
            params.topMargin = AndroidUtilities.dp(8)
            params.bottomMargin = AndroidUtilities.dp(8)
            container.addView(edit_text, params)
            
            def on_save(dialog, which):
                path = str(edit_text.getText().toString()).strip()
                if path:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                    if os.path.exists(path):
                        self.set_setting("typing_sound_custom_path", path)
                        self._sync_settings_to_dex()
                        BulletinHelper.show_success(
                            f"–ü—É—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {os.path.basename(path)}" if is_ru else 
                            f"Path saved: {os.path.basename(path)}"
                        )
                    else:
                        BulletinHelper.show_error(
                            "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω" if is_ru else "File not found"
                        )
                dialog.dismiss()
            
            builder = AlertDialogBuilder(activity)
            builder.set_title("–ü—É—Ç—å –∫ –∞—É–¥–∏–æ —Ñ–∞–π–ª—É" if is_ru else "Audio File Path")
            builder.set_view(container, AndroidUtilities.dp(60))
            builder.set_positive_button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" if is_ru else "Save", on_save)
            builder.set_negative_button("–û—Ç–º–µ–Ω–∞" if is_ru else "Cancel", lambda d, w: d.dismiss())
            builder.show()
            
        except Exception as e:
            self.log(f"Show path dialog error: {e}")
            BulletinHelper.show_error(str(e))
    
    def _show_test_dialog(self, view=None):
        from ui.alert import AlertDialogBuilder
        from java import jclass
        
        try:
            fragment = get_last_fragment()
            if not fragment:
                self.log("No fragment available")
                return
            
            activity = fragment.getParentActivity()
            if not activity:
                self.log("No activity available")
                return
            
            FrameLayout = jclass("android.widget.FrameLayout")
            LayoutParams = jclass("android.widget.FrameLayout$LayoutParams")
            TypedValue = jclass("android.util.TypedValue")
            Gravity = jclass("android.view.Gravity")
            Theme = jclass("org.telegram.ui.ActionBar.Theme")
            AndroidUtilities = jclass("org.telegram.messenger.AndroidUtilities")
            
            EditTextCaption = jclass("org.telegram.ui.Components.EditTextCaption")
            
            container = FrameLayout(activity)
            
            edit_text = EditTextCaption(activity, None)
            edit_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18)
            edit_text.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            edit_text.setHintTextColor(Theme.getColor(Theme.key_dialogTextHint))
            try:
                edit_text.setBackgroundDrawable(None)
            except:
                pass

            edit_text.setPadding(
                AndroidUtilities.dp(24),
                AndroidUtilities.dp(16),
                AndroidUtilities.dp(24),
                AndroidUtilities.dp(16)
            )
            edit_text.setGravity(Gravity.TOP | Gravity.LEFT)
            edit_text.setInputType(1 | 0x00020000 | 0x00004000) 
            edit_text.setMaxLines(6)
            edit_text.setSingleLine(False)
            
            is_ru = self._is_russian()
            hint_text = "–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞ –∞–Ω–∏–º–∞—Ü–∏–∏..." if is_ru else "Start typing to test animation..."
            edit_text.setHint(hint_text)
            
            params = LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT)
            container.addView(edit_text, params)
            
            title = "–¢–µ—Å—Ç –∞–Ω–∏–º–∞—Ü–∏–∏" if is_ru else "Animation Test"
            close_text = "–ó–∞–∫—Ä—ã—Ç—å" if is_ru else "Close"
            
            builder = AlertDialogBuilder(activity)
            builder.set_title(title)
            builder.set_view(container, AndroidUtilities.dp(150))
            builder.set_positive_button(close_text, lambda b, w: b.dismiss())
            builder.show()
            
            def setup_focus():
                try:
                    edit_text.requestFocus()
                except:
                    pass
            
            run_on_ui_thread(setup_focus, delay=200)
            
        except Exception as e:
            self.log(f"Error showing test dialog: {e}")
            BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}" if self._is_russian() else f"Error: {e}")
    
    def _sync_settings_to_dex(self):
        if self.dex_loader:
            settings = {}
            for key in CONFIG_KEYS:
                settings[key] = self.get_setting(key, CONFIG_DEFAULTS.get(key))
            self.dex_loader.update_settings(settings)
    
    def on_plugin_load(self) -> None:
        self.log(f"Loading Text Animation v{__version__} (DEX)...")
        self._load_attempt = 0
        self._hooks = []
        self._hook_android_utilities()
        self._try_load_dex()
    
    def _hook_android_utilities(self):
        try:
            self.log("Hooking AndroidUtilities...")
            AU = JClass.forName("org.telegram.messenger.AndroidUtilities")
            methods = AU.getDeclaredMethods()
            for m in methods:
                if m.getName() == "openDocument" and len(m.getParameterTypes()) == 3:
                    if "MessageObject" in m.getParameterTypes()[0].getName():
                        m.setAccessible(True)
                        self._hooks.append(self.hook_method(m, OpenDocumentHook(self)))
                        self.log("Hooked AndroidUtilities.openDocument")
                
                if m.getName() == "openForView" and len(m.getParameterTypes()) == 4:
                    if "MessageObject" in m.getParameterTypes()[0].getName():
                        m.setAccessible(True)
                        self._hooks.append(self.hook_method(m, OpenDocumentHook(self)))
                        self.log("Hooked AndroidUtilities.openForView")
        except Exception as e:
            self.log(f"Error hooking AndroidUtilities: {e}")
    
    def _try_load_dex(self):
        self._load_attempt += 1
        max_attempts = 5
        
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            
            if not activity:
                if self._load_attempt < max_attempts:
                    self.log(f"Activity not ready, retry {self._load_attempt}/{max_attempts}...")
                    run_on_ui_thread(self._try_load_dex, delay=500)
                    return
                else:
                    self.log("Failed to get activity after max attempts")
                    return
            
            self.dex_loader = DexLoader(self)
            
            cached = self.dex_loader.load_from_cache()
            if cached:
                self.dex_loader.start_from_bytes(cached)
                run_on_ui_thread(self._sync_settings_to_dex, delay=100)
                self.log("DEX loaded from cache!")
                
                def check_updates():
                    try:
                        if self.dex_loader and self.dex_loader.check_for_updates():
                            self.dex_loader.download_dex()
                            is_ru = self._is_russian()
                            msg = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Text Animation –∑–∞–≥—Ä—É–∂–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ." if is_ru else \
                                  "Text Animation update downloaded! Restart the app."
                            run_on_ui_thread(lambda: BulletinHelper.show_info(msg, get_last_fragment()))
                    except Exception as e:
                        self.log(f"Update check error: {e}")
                
                import threading
                threading.Thread(target=check_updates, daemon=True).start()
            else:
                self.log("No cache, downloading DEX in background...")
                
                def download_and_start():
                    try:
                        self.dex_loader.load_and_start()
                        run_on_ui_thread(self._sync_settings_to_dex, delay=100)
                        is_ru = self._is_russian()
                        run_on_ui_thread(lambda: BulletinHelper.show_success(
                            "Text Animation –∑–∞–≥—Ä—É–∂–µ–Ω!" if is_ru else "Text Animation loaded!"
                        ))
                    except Exception as e:
                        self.log(f"Background load error: {e}")
                        is_ru = self._is_russian()
                        run_on_ui_thread(lambda: BulletinHelper.show_error(
                            f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}" if is_ru else f"Load error: {e}"
                        ))
                
                import threading
                threading.Thread(target=download_and_start, daemon=True).start()
            
            self.log("Plugin initialization complete!")
            
        except Exception as e:
            self.log(f"Load error: {e}")
            if self._load_attempt < max_attempts:
                run_on_ui_thread(self._try_load_dex, delay=1000)
            else:
                BulletinHelper.show_error(f"Text Animation error: {e}")
    
    def on_plugin_unload(self) -> None:
        for h in self._hooks:
            self.unhook_method(h)
        self._hooks.clear()
        
        if self.dex_loader:
            self.dex_loader.unload()
            self.dex_loader = None
        self.log("Plugin unloaded")

    def create_settings(self) -> list[Any]:
        is_ru = self._is_russian()
        
        on_change = self._on_setting_change
        
        slide_enabled = self.get_setting("slide_enabled", True)
        scale_enabled = self.get_setting("scale_enabled", False)
        rotate_enabled = self.get_setting("rotate_enabled", False)
        delete_enabled = self.get_setting("delete_anim_enabled", True)
        assemble_enabled = self.get_setting("assemble_anim_enabled", False)
        liquid_enabled = self.get_setting("liquid_cursor_enabled", False)
        spoiler_enabled = self.get_setting("spoiler_enabled", False)
        
        settings = [
            Header(text="–û—Å–Ω–æ–≤–Ω—ã–µ" if is_ru else "General"),
            
            Switch(
                key="enabled",
                text="–í–∫–ª—é—á–∏—Ç—å –ø–ª–∞–≥–∏–Ω" if is_ru else "Enable Plugin",
                default=True,
                subtext="–ì–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å" if is_ru else "Master switch",
                icon="",
                on_change=on_change
            ),
            
            Text(
                text="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é" if is_ru else "Test Animation",
                icon="msg_photo_curve_solar",
                accent=True,
                on_click=self._show_test_dialog
            ),
            
            Divider(),
            Header(text="–°–ø–æ–π–ª–µ—Ä" if is_ru else "Spoiler"),
            
            Switch(
                key="spoiler_enabled",
                text="–≠—Ñ—Ñ–µ–∫—Ç —Å–ø–æ–π–ª–µ—Ä–∞" if is_ru else "Spoiler Effect",
                default=False,
                subtext="–ë—É–∫–≤—ã –∑–∞–∫—Ä—ã—Ç—ã —à—É–º–æ–º –ø–µ—Ä–µ–¥ –∞–Ω–∏–º–∞—Ü–∏–µ–π" if is_ru else "Chars covered by noise before animation",
                icon="msg_secret_solar",
                on_change=on_change
            ),
        ]

        if spoiler_enabled:
            settings.extend([
                Input(
                    key="spoiler_duration",
                    text="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–ø–æ–π–ª–µ—Ä–∞ (–º—Å)" if is_ru else "Spoiler Duration (ms)",
                    default="1000",
                    subtext="–ö–∞–∫ –¥–æ–ª–≥–æ —Å–∫—Ä—ã—Ç —Ç–µ–∫—Å—Ç" if is_ru else "How long text remains hidden",
                    icon="msg_contacts_time_solar",
                    on_change=on_change
                ),
                Input(
                    key="spoiler_particle_speed",
                    text="–°–∫–æ—Ä–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Speed",
                    default="50",
                    subtext="–°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü (10-100)" if is_ru else "Particle movement speed (10-100)",
                    icon="msg_speed",
                    on_change=on_change
                ),
                Input(
                    key="spoiler_particle_count",
                    text="–ö–æ–ª-–≤–æ —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Count",
                    default="15",
                    subtext="–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü (5-30)" if is_ru else "Particle density (5-30)",
                    icon="msg_settings_ny_solar",
                    on_change=on_change
                ),
                Input(
                    key="spoiler_fade_in",
                    text="–ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ (–º—Å)" if is_ru else "Fade In (ms)",
                    default="150",
                    subtext="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–ø–æ–π–ª–µ—Ä–∞" if is_ru else "Spoiler appear duration",
                    icon="msg_photo_blur_solar",
                    on_change=on_change
                ),
                Input(
                    key="spoiler_fade_out",
                    text="–ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ (–º—Å)" if is_ru else "Fade Out (ms)",
                    default="200",
                    subtext="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è —Å–ø–æ–π–ª–µ—Ä–∞" if is_ru else "Spoiler disappear duration",
                    icon="msg_photo_blur_solar",
                    on_change=on_change
                ),
            ])
        
        settings.extend([
            Divider(),
            Header(text="–¢–∞–π–º–∏–Ω–≥–∏" if is_ru else "Timing"),
            
            Input(
                key="duration",
                text="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º—Å)" if is_ru else "Duration (ms)",
                default="300",
                subtext="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è" if is_ru else "Motion duration",
                icon="msg_contacts_time_solar",
                on_change=on_change
            ),
            
            Input(
                key="blur_duration",
                text="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑–º—ã—Ç–∏—è (–º—Å)" if is_ru else "Blur Duration (ms)",
                default="300",
                subtext="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑–º—ã—Ç–∏—è" if is_ru else "Blur duration",
                icon="msg_contacts_time_solar",
                on_change=on_change
            ),
            
            Divider(),
            Header(text="–†–∞–∑–º—ã—Ç–∏–µ" if is_ru else "Blur"),
            
            Switch(
                key="blur_enabled",
                text="–í–∫–ª—é—á–∏—Ç—å —Ä–∞–∑–º—ã—Ç–∏–µ" if is_ru else "Enable Blur",
                default=True,
                subtext="–†–∞–∑–º—ã—Ç–∏–µ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏" if is_ru else "Blur on appearance",
                icon="msg_photo_blur_solar",
                on_change=on_change
            ),
            
            Input(
                key="blur_radius",
                text="–†–∞–¥–∏—É—Å —Ä–∞–∑–º—ã—Ç–∏—è" if is_ru else "Blur Radius",
                default="10",
                subtext="–°–∏–ª–∞ —Ä–∞–∑–º—ã—Ç–∏—è (5-15)" if is_ru else "Blur strength (5-15)",
                icon="msg_instant_link_solar",
                on_change=on_change
            ),
            
            Input(
                key="blur_text_delay",
                text="–ó–∞–¥–µ—Ä–∂–∫–∞ —Ç–µ–∫—Å—Ç–∞ (%)" if is_ru else "Text Delay (%)",
                default="20",
                subtext="–ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç (0-100)" if is_ru else "When text appears (0-100)",
                icon="msg_contacts_time_solar",
                on_change=on_change
            ),
            
            Divider(),
            Header(text="–°–ª–∞–π–¥" if is_ru else "Slide"),
            
            Switch(
                key="slide_enabled",
                text="–í–∫–ª—é—á–∏—Ç—å —Å–ª–∞–π–¥" if is_ru else "Enable Slide",
                default=True,
                subtext="–ë—É–∫–≤—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–≤–µ—Ä—Ö—É" if is_ru else "Characters slide from above",
                icon="msg_contacts_name_solar",
                on_change=on_change
            ),
        ])
        
        if slide_enabled:
            settings.append(Input(
                key="slide_dist",
                text="–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Å–ª–∞–π–¥–∞" if is_ru else "Slide Distance",
                default="20",
                subtext="–ü–∏–∫—Å–µ–ª–∏ —Å–º–µ—â–µ–Ω–∏—è" if is_ru else "Offset pixels",
                icon="msg_map_type_solar",
                on_change=on_change
            ))
        
        settings.extend([
            Divider(),
            Header(text="–ú–∞—Å—à—Ç–∞–±" if is_ru else "Scale"),
            
            Switch(
                key="scale_enabled",
                text="–í–∫–ª—é—á–∏—Ç—å –º–∞—Å—à—Ç–∞–±" if is_ru else "Enable Scale",
                default=False,
                subtext="–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏" if is_ru else "Scale on appearance",
                icon="msg_instant_link_solar",
                on_change=on_change
            ),
        ])
        
        if scale_enabled:
            settings.append(Input(
                key="scale_start",
                text="–ù–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±" if is_ru else "Start Scale",
                default="0.0",
                subtext="0.0 - —Ä–æ—Å—Ç, >1.0 - —É–º–µ–Ω—å—à–µ–Ω–∏–µ" if is_ru else "0.0 - grow, >1.0 - shrink",
                icon="msg_zoomin_solar",
                on_change=on_change
            ))

        settings.extend([
            Divider(),
            Header(text="–ü–æ–≤–æ—Ä–æ—Ç" if is_ru else "Rotate"),
            
            Switch(
                key="rotate_enabled",
                text="–í–∫–ª—é—á–∏—Ç—å –ø–æ–≤–æ—Ä–æ—Ç" if is_ru else "Enable Rotate",
                default=False,
                subtext="–í—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏" if is_ru else "Rotate on appearance",
                icon="msg_reset_solar",
                on_change=on_change
            ),
        ])
        
        if rotate_enabled:
            settings.append(Input(
                key="rotate_angle",
                text="–£–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞" if is_ru else "Rotation Angle",
                default="-15",
                subtext="–ì—Ä–∞–¥—É—Å—ã –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞" if is_ru else "Start rotation degrees",
                icon="burn_remix",
                on_change=on_change
            ))
        
        settings.extend([
            Divider(),
            Header(text="–≠—Ñ—Ñ–µ–∫—Ç –¢–∞–Ω–æ—Å–∞" if is_ru else "Thanos Effect"),
            
            Switch(
                key="delete_anim_enabled",
                text="–≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞–ª–µ–Ω–∏—è" if is_ru else "Delete Effect",
                default=True,
                subtext="–ß–∞—Å—Ç–∏—Ü—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏" if is_ru else "Particles on delete",
                icon="msg_trending_solar",
                on_change=on_change
            ),
        ])
        
        if delete_enabled:
            settings.extend([
                Input(
                    key="particle_count",
                    text="–ö–æ–ª-–≤–æ —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Count",
                    default="5",
                    subtext="–ß–∞—Å—Ç–∏—Ü –Ω–∞ —Å–∏–º–≤–æ–ª (1-20)" if is_ru else "Per char (1-20)",
                    icon="msg_settings_ny_solar",
                    on_change=on_change
                ),
                Input(
                    key="particle_speed",
                    text="–°–∫–æ—Ä–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Speed",
                    default="50",
                    subtext="–°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑–ª–µ—Ç–∞ (10-100)" if is_ru else "Speed (10-100)",
                    icon="msg_speed",
                    on_change=on_change
                ),
                Input(
                    key="particle_size",
                    text="–†–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Size",
                    default="50",
                    subtext="–†–∞–∑–º–µ—Ä (10-100)" if is_ru else "Size (10-100)",
                    icon="msg_zoomin_solar",
                    on_change=on_change
                ),
                Switch(
                    key="ignore_mass_delete",
                    text="–ò–≥–Ω–æ—Ä. –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ" if is_ru else "Ignore on Send",
                    default=True,
                    subtext="–û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ" if is_ru else "Disable on send",
                    icon="msg_send",
                    on_change=on_change
                ),
                Input(
                    key="mass_delete_threshold",
                    text="–ü–æ—Ä–æ–≥ —Å–∏–º–≤–æ–ª–æ–≤" if is_ru else "Threshold",
                    default="3",
                    subtext="–ú–∏–Ω. —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –º–∞—Å—Å. —É–¥–∞–ª–µ–Ω–∏—è" if is_ru else "Min chars for mass delete",
                    icon="leave_solar",
                    on_change=on_change
                ),
            ])
        
        settings.extend([
            Divider(),
            Header(text="–û–±—Ä–∞—Ç–Ω—ã–π –¢–∞–Ω–æ—Å" if is_ru else "Reverse Thanos"),
            
            Switch(
                key="assemble_anim_enabled",
                text="–≠—Ñ—Ñ–µ–∫—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è" if is_ru else "Appear Effect",
                default=False,
                subtext="–ß–∞—Å—Ç–∏—Ü—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ —Å–∏–º–≤–æ–ª—ã" if is_ru else "Particles assemble into chars",
                icon="msg_trending_solar",
                on_change=on_change
            ),
        ])
        
        if assemble_enabled:
            settings.extend([
                Input(
                    key="assemble_particle_count",
                    text="–ö–æ–ª-–≤–æ —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Count",
                    default="5",
                    icon="msg_settings_ny_solar",
                    on_change=on_change
                ),
                Input(
                    key="assemble_particle_speed",
                    text="–°–∫–æ—Ä–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Speed",
                    default="50",
                    icon="msg_speed",
                    on_change=on_change
                ),
                Input(
                    key="assemble_particle_size",
                    text="–†–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü" if is_ru else "Particle Size",
                    default="50",
                    icon="msg_zoomin_solar",
                    on_change=on_change
                ),
                Input(
                    key="assemble_spread",
                    text="–†–∞–¥–∏—É—Å —Ä–∞–∑–±—Ä–æ—Å–∞" if is_ru else "Spread Radius",
                    default="50",
                    subtext="–ù–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (20-100)" if is_ru else "Initial distance (20-100)",
                    icon="msg_map_type_solar",
                    on_change=on_change
                ),
            ])

        settings.extend([
            Divider(),
            Header(text="–ö—É—Ä—Å–æ—Ä" if is_ru else "Cursor"),
            
            Switch(
                key="cursor_enabled",
                text="–ü–ª–∞–≤–Ω—ã–π –∫—É—Ä—Å–æ—Ä" if is_ru else "Smooth Cursor",
                default=True,
                subtext="–ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞" if is_ru else "Fluid cursor movement",
                icon="msg_channel_14_solar",
                on_change=on_change
            ),
            
            Input(
                key="cursor_speed",
                text="–°–∫–æ—Ä–æ—Å—Ç—å (10-100)" if is_ru else "Speed (10-100)",
                default="25",
                subtext="–°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏" if is_ru else "Animation speed",
                icon="msg_speed",
                on_change=on_change
            ),
            
            Input(
                key="cursor_width",
                text="–®–∏—Ä–∏–Ω–∞ –∫—É—Ä—Å–æ—Ä–∞" if is_ru else "Cursor Width",
                default="5",
                subtext="–¢–æ–ª—â–∏–Ω–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö" if is_ru else "Thickness in pixels",
                icon="msg_edit",
                on_change=on_change
            ),
            
            Switch(
                key="liquid_cursor_enabled",
                text="–ñ–∏–¥–∫–∏–π –∫—É—Ä—Å–æ—Ä" if is_ru else "Liquid Cursor",
                default=False,
                subtext="–î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏" if is_ru else "Deformation on movement",
                icon="msg_payment_delivery_solar",
                on_change=on_change
            ),
        ])
        
        if liquid_enabled:
            settings.append(Input(
                key="liquid_scale_factor",
                text="–°–∏–ª–∞ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è" if is_ru else "Stretch Strength",
                default="15",
                subtext="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (5-50)" if is_ru else "Factor (5-50)",
                icon="msg_noise_on_solar",
                on_change=on_change
            ))
        
        # –°–µ–∫—Ü–∏—è –∑–≤—É–∫–∞ –ø–µ—á–∞—Ç–∏
        typing_sound_enabled = self.get_setting("typing_sound_enabled", False)
        
        settings.extend([
            Divider(),
            Header(text="üîä –ó–≤—É–∫ –ø–µ—á–∞—Ç–∏" if is_ru else "üîä Typing Sound"),
            
            Switch(
                key="typing_sound_enabled",
                text="–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫" if is_ru else "Enable Sound",
                default=False,
                subtext="–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∑–≤—É–∫ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏" if is_ru else "Play sound when typing",
                icon="msg_voice_solar",
                on_change=on_change
            ),
        ])
        
        if typing_sound_enabled:
            settings.extend([
                Selector(
                    key="typing_sound_type",
                    text="–¢–∏–ø –∑–≤—É–∫–∞" if is_ru else "Sound Type",
                    default=0,
                    items=["–°–∏—Å—Ç–µ–º–Ω—ã–π –∫–ª–∏–∫", "–ü–µ—á–∞—Ç–Ω–∞—è –º–∞—à–∏–Ω–∫–∞", "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π", "–ú—è–≥–∫–∏–π", "–ü—É–∑—ã—Ä—å–∫–∏", "–°–≤–æ–π —Ñ–∞–π–ª"] if is_ru else 
                          ["System Click", "Typewriter", "Mechanical", "Soft", "Bubble", "Custom File"],
                    icon="msg_music_solar",
                    on_change=on_change
                ),
                Input(
                    key="typing_sound_volume",
                    text="–ì—Ä–æ–º–∫–æ—Å—Ç—å (%)" if is_ru else "Volume (%)",
                    default="50",
                    subtext="–ì—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–∞ (0-100)" if is_ru else "Sound volume (0-100)",
                    icon="msg_volume_solar",
                    on_change=on_change
                ),
                Input(
                    key="typing_sound_pitch",
                    text="–í—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞ (%)" if is_ru else "Pitch (%)",
                    default="100",
                    subtext="–ë–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ –∑–≤—É–∫–∞ (50-200)" if is_ru else "Base sound pitch (50-200)",
                    icon="msg_tune_solar",
                    on_change=on_change
                ),
                Switch(
                    key="typing_sound_pitch_variation",
                    text="–í–∞—Ä–∏–∞—Ü–∏—è —Ç–æ–Ω–∞" if is_ru else "Pitch Variation",
                    default=True,
                    subtext="–°–ª—É—á–∞–π–Ω–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã" if is_ru else "Random pitch variation",
                    icon="msg_shuffle_solar",
                    on_change=on_change
                ),
                Input(
                    key="typing_sound_pitch_range",
                    text="–î–∏–∞–ø–∞–∑–æ–Ω –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)" if is_ru else "Variation Range (%)",
                    default="10",
                    subtext="–î–∏–∞–ø–∞–∑–æ–Ω —Å–ª—É—á–∞–π–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏ (0-30)" if is_ru else "Random variation range (0-30)",
                    icon="msg_range_solar",
                    on_change=on_change
                ),
                Text(
                    text="–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π –∞—É–¥–∏–æ —Ñ–∞–π–ª" if is_ru else "Select Custom Audio File",
                    icon="msg_folder_solar",
                    accent=True,
                    on_click=self._pick_custom_sound
                ),
            ])
        
        settings.extend([
            Divider(),
            Header(text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ" if is_ru else "Additional"),
            
            Switch(
                key="ignore_spaces",
                text="–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã" if is_ru else "Ignore Spaces",
                default=True,
                subtext="–ù–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã –∏ —á–∞—Å—Ç–∏—Ü—ã" if is_ru else "Skip spaces and particles",
                icon="input_keyboard",
                on_change=on_change
            ),
            
            Switch(
                key="debug_mode",
                text="–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏" if is_ru else "Debug Mode",
                default=False,
                subtext="–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫" if is_ru else "Error logging",
                icon="msg_settings_solar",
                on_change=on_change
            ),
            
            Divider(),
            Header(text="–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è" if is_ru else "Configuration"),
            
            Text(
                text="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" if is_ru else "Export Settings",
                icon="msg_share",
                accent=True,
                on_click=self._save_config_to_file
            ),
            
            Text(
                text="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" if is_ru else "Import Settings",
                icon="msg_download",
                accent=True,
                on_click=self._show_import_dialog
            ),
            
            Divider(),
            Header(text="–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ" if is_ru else "Maintenance"),
            
            Text(
                text="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à DEX" if is_ru else "Clear DEX Cache",
                icon="msg_delete",
                accent=True,
                on_click=self._clear_dex_cache
            ),
            
            Divider(
                text="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ .animtext –∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å!" if is_ru else "Export to .animtext and share!"
            ),
        ])
        
        return settings